parameters:
  agentOS: 'Darwin|Linux|Windows_NT'
  jobName: 'perf_test'
  displayName: 'Windows Server 2016'

jobs:
- job: ${{ parameters.jobName }}
  pool:
    name: PS-Performance
    demands:
    - agent.os -equals ${{ parameters.agentOS }}
  displayName: ${{ parameters.displayName }}

  steps:

  - pwsh: |
      git clone https://github.com/adityapatwardhan/PSSnowball "$(Build.SourcesDirectory)/PSSnowball"
    displayName: Git clone PSSnowball

  - pwsh: |
      $pwshPath = if ($PSBuildId) {
          test/performance/azDevOps/get-latestpsbuild.ps1 -Destination $(Build.ArtifactStagingDirectory) -Token $(BuildAccessToken) -BuildId $(PSBuildId)
      } else {
          test/performance/azDevOps/get-latestpsbuild.ps1 -Destination $(Build.ArtifactStagingDirectory) -Token $(BuildAccessToken)
      }

      $vstsCommandString = "vso[task.setvariable variable=PwshPath]$pwshPath"
      Write-Host "sending " + $vstsCommandString
      Write-Host "##$vstsCommandString"

    displayName: Install PowerShell build

  - pwsh: |
      Import-Module "$(Build.SourcesDirectory)/PSSnowball/PSSnowball" -force
      $results = @()

      # Start run
      Start-PSSnowballRun -Verbose -InstrumentationKey '$(PerfAppInsightsKey)' -PwshPath '$(PwshPath)'

      # Make sure powershell analysis cache is setup
      Invoke-PSSnowballRunInitScript -ScriptBlock { Get-Module -ListAvailable } | Out-Null

      # Get-Help test
      $results += Invoke-PSSnowballTest -TestName "GetHelpNonExistent" -ScriptBlock { Get-Help DoesNotExist -ErrorAction SilentlyContinue} -Setup { $ProgressPreference = 'silentlycontinue'; $originalPath = $env:PSModulePath; $env:PSModulePath = (Join-Path $PSHOME "Modules")} -TearDown { $env:PSModulePath = $originalPath } -Verbose

      # Get-Command test
      $results += Invoke-PSSnowballTest -TestName "GetCommand" -ScriptBlock { Get-Command } -Setup { $originalPath = $env:PSModulePath; $env:PSModulePath = (Join-Path $PSHOME "Modules")} -TearDown { $env:PSModulePath = $originalPath } -Verbose

      # Get-Module ListAvailable test
      $results += Invoke-PSSnowballTest -TestName "GetModuleListAvailable" -ScriptBlock { Get-Module -ListAvailable } -Setup { $originalPath = $env:PSModulePath; $env:PSModulePath = (Join-Path $PSHOME "Modules")} -TearDown { $env:PSModulePath = $originalPath } -Verbose

      # Stop run
      Stop-PSSnowballRun
    displayName: Execute Tests
